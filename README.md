# Microsoft Malware Prediction
kaggleのMicrosoft Malware Predictionに参加した際の備忘録

### 内容
2018年12月〜2019年3月の間にkaggleで開催されていたMicrosoft Malware Predictionのコンペに
参加しました。  
初めて予測スコアの提出まで行い、多くの学びがあったので作成したコード、やってみたこと、反省点、今後の課題をまとめました。

### コンペ概要
Microsoftが提供するPCのデータを元に、テストデータとして与えられるPCが  
すぐにマルウェアに感染するか否かを予測するコンペ（二値分類）。  
訓練データ8921483件、テストデータ7853253件が与えられる。  
各データを一意に識別するカラムは「MachineIdentifier」列で、  
ラベルは「HasDetections」列。  
「HasDetections」列の値が1のデータはマルウェアが検出されたPC、0のデータはマルウェアが検出されていないPCという事になる。  
データの詳細は以下リンクのData Description欄を参照。  
<https://www.kaggle.com/c/microsoft-malware-prediction/data>

### やってみたこと  
大まかな流れとして、
1. 前処理
2. 訓練データをモデルにfit
3. テストデータをpredict  
の順で処理するコードを書きました。

以下にそれぞれの工程で試みたことを詳しく記載します。  

#### 1. 前処理  
今回作成したコードの前処理の流れを細分化すると、以下のようになります。  
**特徴量の追加・削除**  
⇩  
**カラムごとの固有の処理**  
⇩  
**カテゴリカル変数を数値化**  
⇩  
**欠損値を平均値で補完**    

それぞれについて、更に詳しく説明します。
#### 特徴量の追加・削除
kaggleのkernelsの投稿を参考に、不要な特徴量の削除・特徴量の合成を行いました。（下記リンクを参照）
<https://www.kaggle.com/nroman/features-correlations>

- 不要なカラムを削除
  以下カラムはラベルとの相関係数が極端に低いため、削除
  * UacLuaenable
  
  以下カラムは他の特徴量の中に相関係数が高いものがあるため、削除
  * Census_OSArchitecture
  * Census_OSSkuName
  * Census_OSUILocaleIdentifier
  * OsBuild
  
  以下カラムはinteractionがあるため、両方の値を連結した値を特徴量として追加し、元のカラムは削除  
  （例えば、Osverの値が同じ10.0.0.0だったとしても、Platformの値がwindows10の場合とwindows2016の場合とでmalware検出率が大きく異なる）
  * OsVer
  * Platform

| Osver | Platform | 全体の個数 | HasDetectionsが1である個数 | HasDetectionsが1である割合 |
|:-----------|------------:|:------------:|:------------:|:------------:|
| 10.0.0.0       | windows10 |     8618174     |  4309331 | <font color="Red">0.500028</font> |
| 10.0.0.0     |      windows2016 |    14371    |  5024  |  <font color="Red">0.349593</font>  |
  
- 特徴量を合成
  * Osver\*Platform（理由は上記の通り）
  

#### カラムの特性ごとの固有の処理
カラム毎にラベルとの相関係数が高くなるような処理を選別して実施（対象は数値変数）
  
- Census_OEMModelIdentifier  
⇨Noneを平均値で補完し、各値を1000で除算して四捨五入（その後ターゲットエンコーディング）

- Census_SystemVolumeTotalCapacity
⇨Noneを中央値で補完し、各値を10で除算して四捨五入（その後ターゲットエンコーディング）

- IsProtected
⇨Noneを0で補完

- Census_InternalBatteryType
⇨lÿÿÿ, ÷ÿóöなどの、ターゲットエンコーディング時に支障が出そうな値は一律「z」に置換。
　置換対象の値の選別基準は、以下の両側検定を実施して帰無仮説を棄却する値以外とした。（Excelで作業）
有意水準：5%
帰無仮説：Census_InternalBatteryTypeが対象の値である行のmalware検出率(HasDetectionsが1である確率)が0.5
対立仮説：Census_InternalBatteryTypeが対象の値である行のmalware検出率(HasDetectionsが1である確率)が0.5ではない
（例）  

| Osver | Platform | HasDetectionsが1である割合 |
|:-----------|------------:|:------------:|
| 10.0.0.0       | windows10 |     0.500028     |
| 10.0.0.0     |      windows2016 |    0.349593    |

- 特徴量を合成対象の
- 特徴量を合成値
- 特徴量を合成
